<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Code Editor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5/lib/codemirror.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5/theme/dracula.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5/addon/lint/lint.css" />

    <script src="https://cdn.jsdelivr.net/npm/codemirror@5/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5/mode/htmlmixed/htmlmixed.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5/mode/javascript/javascript.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5/mode/css/css.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5/mode/xml/xml.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/codemirror@5/addon/lint/lint.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/htmlhint@1.1.4/dist/htmlhint.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5/addon/lint/html-lint.js"></script>
    <script src="https://unpkg.com/csslint@1.0.5/dist/csslint.js"></script>
    <script src="https://unpkg.com/codemirror@5.65.17/addon/lint/css-lint.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jshint@2.13.6/dist/jshint.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5/addon/lint/javascript-lint.js"></script>


    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* Global Styles */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Roboto', sans-serif; /* A common, clean font */
            background: #1e1e1e;
            color: white;
            overflow: hidden; /* Prevent body scrolling beyond what's managed */
            display: flex;
            flex-direction: column; /* Arrange content vertically */
        }

        /* Tab Bar for HTML/CSS/JS Selection */
        .tab-bar {
            display: flex;
            width: 100%;
            background: #282c34; /* Darker background */
            border-bottom: 1px solid #3a3f4b;
            flex-shrink: 0; /* Prevent it from shrinking */
        }

        .tab-bar button {
            flex: 1;
            padding: 12px 0;
            font-size: 16px;
            color: #aaa; /* Lighter grey for inactive tabs */
            background: transparent;
            border: none;
            cursor: pointer;
            transition: color 0.2s ease, background-color 0.2s ease;
        }

        .tab-bar button.active {
            color: white; /* White for active tab text */
            background-color: #3a3f4b; /* Slightly lighter background for active tab */
            font-weight: bold;
        }

        /* Editor Container */
        .editor-container {
            flex-grow: 1; /* Allow editor to take remaining height */
            display: flex;
            flex-direction: column;
            position: relative; /* For absolutely positioned elements within */
            overflow: hidden; /* To handle CodeMirror's internal scrollbar */
        }

        /* CodeMirror Editor Specifics */
        .CodeMirror {
            height: 100% !important; /* Ensure CodeMirror takes full height */
            font-size: 14px;
            line-height: 1.5; /* Improve readability */
            flex-grow: 1; /* Allow editor to grow within container */
        }
        .CodeMirror-gutters {
            background-color: #282c34 !important; /* Match tab/button background */
            border-right: 1px solid #3a3f4b !important;
        }
        .CodeMirror-linenumber {
            color: #888 !important;
        }

        /* Button Bar (Run, Save, Load) */
        .button-bar {
            width: 100%;
            display: flex;
            background: #282c34; /* Match tab/gutter background */
            border-top: 1px solid #3a3f4b;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3); /* Subtle shadow */
            z-index: 999; /* Ensure it stays on top */
            flex-shrink: 0; /* Prevent it from shrinking */
        }

        .button-bar button {
            flex: 1;
            padding: 12px 0; /* Adjust padding */
            font-size: 16px;
            background: transparent; /* No background, use bar's background */
            color: white;
            border: none;
            cursor: pointer;
            display: flex; /* For icon and text alignment */
            align-items: center;
            justify-content: center;
            gap: 8px; /* Space between icon and text */
            transition: background-color 0.2s ease;
        }

        .button-bar button:hover,
        .button-bar button:active {
            background-color: #3a3f4b; /* Subtle hover/active effect */
        }

        .button-bar button .material-icons {
            font-size: 20px;
        }

        /* Iframe Output - Adjusting positioning for potential browser UI */
        iframe {
            position: fixed; /* Position fixed relative to viewport */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Take full available space */
            border: none;
            background: white;
            z-index: 998; /* Below the button bar */
            transition: opacity 0.3s ease; /* Smooth transition for showing/hiding */
        }

        /* New styles for the "Back to Editor" button container */
        #backToEditorBar {
            position: fixed; /* Fixed to the viewport */
            bottom: 0; /* Position at the bottom */
            left: 0;
            width: 100%;
            display: flex;
            background: #282c34; /* Match existing button bar style */
            border-top: 1px solid #3a3f4b;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 999; /* Ensure it's above the iframe */
        }

        #backToEditorBar button {
            flex: 1;
            padding: 12px 0;
            font-size: 16px;
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s ease;
        }

        #backToEditorBar button:hover,
        #backToEditorBar button:active {
            background-color: #3a3f4b;
        }

        #backToEditorBar button .material-icons {
            font-size: 20px;
        }

        /* Floating Copy Button */
        .copy-floating-button {
            position: fixed;
            bottom: 70px; /* Adjust as needed to be above the bottom bar */
            right: 20px;
            z-index: 1000; /* Ensure it's above everything else */
            background-color: #282c34; /* Match editor background */
            color: white;
            border: none;
            border-radius: 50%; /* Make it circular */
            width: 40px; /* Smaller size */
            height: 40px; /* Smaller size */
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease, opacity 0.2s ease, visibility 0.2s ease;
            opacity: 1;
            visibility: visible;
        }

        .copy-floating-button:hover {
            background-color: #3a3f4b; /* Slightly lighter on hover */
            transform: translateY(-2px);
        }

        .copy-floating-button .material-icons {
            font-size: 20px; /* Icon size */
        }

        .copy-floating-button.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none; /* Prevent clicks when hidden */
        }

        /* Styles for mobile view simulation */
        iframe.mobile-view {
            width: 375px; /* Common iPhone 6/7/8 width */
            height: 667px; /* Common iPhone 6/7/8 height */
            position: absolute; /* Change from fixed to absolute to center easily within parent */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Center trick */
            box-shadow: 0 0 15px rgba(0,0,0,0.5); /* Adds a slight device-like shadow */
            border-radius: 10px; /* Rounded corners */
            transition: width 0.3s ease, height 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease, border-radius 0.3s ease;
        }

        /* Ensure desktop mode reverts styles cleanly */
        iframe.desktop-view {
            width: 100%;
            height: 100%;
            position: fixed; /* Revert to fixed for full screen */
            top: 0;
            left: 0;
            transform: none;
            box-shadow: none;
            border-radius: 0;
            transition: width 0.3s ease, height 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease, border-radius 0.3s ease;
        }


        /* Utility Classes */
        .hidden {
            display: none !important;
            opacity: 0; /* For transition effect when showing/hiding elements that are not fixed */
            pointer-events: none; /* Prevent interaction when hidden */
        }

    </style>
</head>
<body>

    <div class="tab-bar" id="editorTabBar">
        <button id="htmlTab" onclick="switchEditor('html')" class="active">HTML</button>
        <button id="cssTab" onclick="switchEditor('css')">CSS</button>
        <button id="jsTab" onclick="switchEditor('js')">JS</button>
    </div>

    <div class="editor-container">
        <textarea id="htmlEditor"></textarea>
        <textarea id="cssEditor" class="hidden"></textarea>
        <textarea id="jsEditor" class="hidden"></textarea>
    </div>

    <div class="button-bar">
        <button id="runBtn" onclick="toggleRun()">
            <span class="material-icons">play_arrow</span>
            <span>Run Code</span>
        </button>
        <button id="saveBtn" onclick="saveCode()">
            <span class="material-icons">download</span>
            <span>Save</span>
        </button>
        <button id="loadBtn" onclick="triggerFileUpload()">
            <span class="material-icons">upload_file</span>
            <span>Load</span>
        </button>
    </div>

    <iframe id="output" class="hidden"></iframe>

    <div id="backToEditorBar" class="hidden">
        <button onclick="toggleRun()">
            <span class="material-icons">edit</span>
            <span>Back to Editor</span>
        </button>
        <button onclick="setPreviewMode('mobile')">
            <span class="material-icons">phone_iphone</span>
            <span>Mobile View</span>
        </button>
        <button onclick="setPreviewMode('desktop')">
            <span class="material-icons">desktop_windows</span>
            <span>Desktop View</span>
        </button>
    </div>

    <div id="copyFloatingButtonContainer" class="copy-floating-button">
        <button onclick="copyAllCurrentEditorCode()" style="background:none; border:none; color:white; padding:0; display:flex; align-items:center; justify-content:center; width:100%; height:100%; cursor:pointer;">
            <span class="material-icons">content_copy</span>
        </button>
    </div>


    <input type="file" id="fileInput" accept=".html,.htm" style="display: none;" onchange="loadCodeFromFile(event)">

    <script>
        // Initialize CodeMirror editors
        let editors = {
            html: CodeMirror.fromTextArea(document.getElementById("htmlEditor"), {
                lineNumbers: true,
                mode: "htmlmixed",
                theme: "dracula",
                lineWrapping: true, // Enable line wrapping
                gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers"], // Add lint markers gutter
                lint: true // Enable linting for HTML
            }),
            css: CodeMirror.fromTextArea(document.getElementById("cssEditor"), {
                lineNumbers: true,
                mode: "css",
                theme: "dracula",
                lineWrapping: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers"], // Add lint markers gutter
                lint: true // Enable linting for CSS
            }),
            js: CodeMirror.fromTextArea(document.getElementById("jsEditor"), {
                lineNumbers: true,
                mode: "javascript",
                theme: "dracula",
                lineWrapping: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers"], // Add lint markers gutter
                lint: true // Enable linting for JavaScript
            })
        };

        let currentMode = "html";
        let inPreview = false;
        const outputIframe = document.getElementById("output"); // Moved here for global access


        /**
         * Switches the currently active editor (HTML, CSS, JS) and updates tab visuals.
         * @param {string} mode - The mode to switch to ('html', 'css', 'js').
         */
        function switchEditor(mode) {
            currentMode = mode;

            // Update editor visibility
            for (let key in editors) {
                const wrapper = editors[key].getWrapperElement();
                wrapper.style.display = (key === mode) ? "block" : "none";
            }
            // Refresh the active editor to ensure proper rendering after display change
            editors[mode].refresh();
            // Manually trigger linting for the newly active editor when switching
            editors[mode].performLint();


            // Update tab button active state
            document.querySelectorAll('.tab-bar button').forEach(button => {
                button.classList.remove('active');
            });
            document.getElementById(`${mode}Tab`).classList.add('active');

            // Ensure floating copy button is visible when switching editors (not in preview)
            if (!inPreview) {
                updateCopyButtonVisibility();
            }
        }

        /**
         * Toggles between the code editor view and the live output preview.
         */
        function toggleRun() {
            // Re-get elements as some might be added/removed from DOM, or simply for clarity
            const editorContainer = document.querySelector('.editor-container');
            const editorTabBar = document.getElementById("editorTabBar");
            const buttonBar = document.querySelector('.button-bar');
            const backToEditorBar = document.getElementById("backToEditorBar");
            const copyFloatingButtonContainer = document.getElementById('copyFloatingButtonContainer');

            if (!inPreview) {
                // Switch to Preview Mode
                const html = editors.html.getValue();
                const css = editors.css.getValue();
                const js = editors.js.getValue();

                // Construct the full HTML for the iframe
                const outputCode = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <style>${css}</style>
</head>
<body>
    ${html}
    <script>${js}<\/script>
</body>
</html>`;

                const doc = outputIframe.contentDocument || outputIframe.contentWindow.document;
                // Make iframe visible
                outputIframe.classList.remove("hidden");
                // Ensure it starts in desktop view when entering preview
                setPreviewMode('desktop'); // Set initial view to desktop


                // Ensure iframe content is written
                doc.open();
                doc.write(outputCode);
                doc.close();

                // Hide editor elements (tab bar and editor container)
                editorContainer.classList.add("hidden");
                editorTabBar.classList.add("hidden");
                buttonBar.classList.add("hidden");
                copyFloatingButtonContainer.classList.add('hidden'); // Hide floating copy button

                // Show the "Back to Editor" button bar with mobile/desktop options
                backToEditorBar.classList.remove("hidden");

                inPreview = true;
            } else {
                // Switch back to Editor Mode
                // Hide iframe
                outputIframe.classList.add("hidden");
                // Remove preview mode classes when going back to editor
                outputIframe.classList.remove('mobile-view');
                outputIframe.classList.remove('desktop-view');


                // Show editor elements (tab bar and editor container)
                editorContainer.classList.remove("hidden");
                editorTabBar.classList.remove("hidden");
                buttonBar.classList.remove("hidden");
                updateCopyButtonVisibility(); // Ensure button is visible or hidden based on content

                // Hide the "Back to Editor" button bar
                backToEditorBar.classList.add("hidden");

                inPreview = false;
                // Refresh the current editor to ensure it's properly rendered when revealed
                editors[currentMode].refresh();
                // Manually trigger linting for the current editor when returning
                editors[currentMode].performLint();
            }
        }

        /**
         * Sets the display mode of the output iframe (mobile or desktop).
         * @param {string} mode - 'mobile' or 'desktop'.
         */
        function setPreviewMode(mode) {
            if (mode === 'mobile') {
                outputIframe.classList.add('mobile-view');
                outputIframe.classList.remove('desktop-view');
            } else { // mode === 'desktop'
                outputIframe.classList.add('desktop-view');
                outputIframe.classList.remove('mobile-view');
            }
            // Trigger a resize event inside the iframe to help content reflow
            if (outputIframe.contentWindow && outputIframe.contentWindow.dispatchEvent) {
                outputIframe.contentWindow.dispatchEvent(new Event('resize'));
            }
        }


        /**
         * Saves (downloads) the current HTML, CSS, and JS as a single .html file.
         */
        function saveCode() {
            const html = editors.html.getValue();
            const css = editors.css.getValue();
            const js = editors.js.getValue();

            const combinedCode = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>My Code Project</title>
    <style>
/* --- Start Custom CSS --- */
${css}
/* --- End Custom CSS --- */
    </style>
</head>
<body>
${html}
<script>
/* --- Start Custom JavaScript --- */
${js}
/* --- End Custom JavaScript --- */
    </\script>
</body>
</html>`;

            const blob = new Blob([combinedCode], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my_project.html'; // Suggested file name
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up the URL object

            alert('Project downloaded as my_project.html!');
        }

        /**
         * Triggers the hidden file input to open the file selection dialog.
         */
        function triggerFileUpload() {
            document.getElementById('fileInput').click();
        }

        /**
         * Loads code from a selected HTML file and populates the editors.
         * @param {Event} event - The change event from the file input.
         */
        function loadCodeFromFile(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('No file selected.');
                return;
            }

            // Check file type if desired (though 'accept' attribute helps)
            if (!file.name.toLowerCase().endsWith('.html') && !file.name.toLowerCase().endsWith('.htm')) {
                alert('Please select an HTML file (.html or .htm).');
                event.target.value = ''; // Clear the input so same file can be selected again
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                const fileContent = e.target.result;
                try {
                    // Parse the HTML content to extract parts
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(fileContent, 'text/html');

                    let loadedHtml = '';
                    let loadedCss = '';
                    let loadedJs = '';

                    // Extract HTML from the body (excluding script and style tags)
                    // Clone the body to avoid modifying the original parsed document
                    const tempBody = doc.body.cloneNode(true);

                    // Remove script and style tags from the cloned body for HTML content
                    tempBody.querySelectorAll('script, style').forEach(el => el.remove());
                    loadedHtml = tempBody.innerHTML.trim(); // Get HTML content after removing scripts/styles

                    // Extract CSS from style tags
                    doc.querySelectorAll('style').forEach(styleTag => {
                        // Check for our custom markers if present, otherwise take all CSS
                        const styleContent = styleTag.textContent.trim();
                        if (styleContent.includes('/* --- Start Custom CSS --- */') && styleContent.includes('/* --- End Custom CSS --- */')) {
                            // Extract content between markers
                            const startIndex = styleContent.indexOf('/* --- Start Custom CSS --- */') + '/* --- Start Custom CSS --- */'.length;
                            const endIndex = styleContent.indexOf('/* --- End Custom CSS --- */');
                            loadedCss += styleContent.substring(startIndex, endIndex).trim() + '\n';
                        } else {
                            loadedCss += styleContent + '\n'; // Fallback if markers not found
                        }
                    });

                    // Extract JS from script tags
                    doc.querySelectorAll('script').forEach(scriptTag => {
                        // Check for our custom markers if present, otherwise take all JS
                        const scriptContent = scriptTag.textContent.trim();
                        if (scriptContent.includes('/* --- Start Custom JavaScript --- */') && scriptContent.includes('/* --- End Custom JavaScript --- */')) {
                            // Extract content between markers
                            const startIndex = scriptContent.indexOf('/* --- Start Custom JavaScript --- */') + '/* --- Start Custom JavaScript --- */'.length;
                            const endIndex = scriptContent.indexOf('/* --- End Custom JavaScript --- */');
                            loadedJs += scriptContent.substring(startIndex, endIndex).trim() + '\n';
                        } else {
                            loadedJs += scriptContent + '\n'; // Fallback if markers not found
                        }
                    });

                    // Populate editors
                    editors.html.setValue(loadedHtml);
                    editors.css.setValue(loadedCss);
                    editors.js.setValue(loadedJs);

                    editors.html.refresh();
                    editors.css.refresh();
                    editors.js.refresh();

                    // After loading, trigger linting for all editors
                    editors.html.performLint();
                    editors.css.performLint();
                    editors.js.performLint();

                    alert('File loaded successfully!');

                } catch (parseError) {
                    console.error("Error parsing HTML file:", parseError);
                    alert('Error parsing the HTML file. It might be corrupted or not a valid format.');
                }
            };

            reader.onerror = function(e) {
                console.error("Error reading file:", reader.error);
                alert('Error reading the selected file. Please try again.');
            };

            reader.readAsText(file); // Read the file content as text

            event.target.value = ''; // Clear the input value to allow re-selecting the same file
        }

        /**
         * Copies all content from the currently active CodeMirror editor to the clipboard.
         */
        function copyAllCurrentEditorCode() {
            const editor = editors[currentMode];
            if (!editor) {
                alert("No editor active.");
                return;
            }

            const textToCopy = editor.getValue();

            // Create a temporary textarea to perform the copy
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            // Position off-screen to avoid visual disruption
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            tempTextArea.style.top = '-9999px';
            document.body.appendChild(tempTextArea);

            // Select the text in the temporary textarea
            tempTextArea.focus();
            tempTextArea.select();
            tempTextArea.setSelectionRange(0, 99999); // For mobile devices to ensure full selection

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    alert('All code copied to clipboard!');
                } else {
                    alert('Failed to copy. Your browser may not support programmatic copy, or security restrictions prevented it.');
                }
            } catch (err) {
                console.error('Copy command failed:', err);
                alert('Failed to copy. Please try selecting the code manually.');
            } finally {
                document.body.removeChild(tempTextArea); // Clean up the temporary textarea
            }
        }

        /**
         * Updates the visibility of the copy button based on whether the current editor has content.
         */
        function updateCopyButtonVisibility() {
            const editor = editors[currentMode];
            const copyButton = document.getElementById('copyFloatingButtonContainer');
            if (editor && editor.getValue().trim() !== '') {
                copyButton.classList.remove('hidden');
            } else {
                copyButton.classList.add('hidden');
            }
        }


        // Initial setup when the page loads
        window.onload = function() {
            switchEditor("html"); // Ensure HTML editor is visible and active by default

            // Add event listeners to CodeMirror instances to detect changes
            for (let key in editors) {
                editors[key].on('change', () => {
                    updateCopyButtonVisibility();
                    editors[key].performLint(); // Trigger lint on change for each editor
                });
            }
            // Manually trigger linting for all editors on load to catch initial errors
            editors.html.performLint();
            editors.css.performLint();
            editors.js.performLint();

            updateCopyButtonVisibility(); // Initial visibility check for copy button
        };
    </script>

</body>
</html>
